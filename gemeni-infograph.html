<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Global Lineage Analysis</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Lexend:wght@400;600;700;900&display=swap');
        body {
            font-family: 'Lexend', sans-serif;
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 450px;
            margin-left: auto;
            margin-right: auto;
            height: 320px;
            max-height: 350px;
        }
        @media (min-width: 768px) {
            .chart-container {
                height: 384px;
                max-height: 400px;
            }
        }
        .timeline-item::before {
            content: '';
            position: absolute;
            left: -35px;
            top: 50%;
            transform: translateY(-50%);
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background-color: #118AB2;
            border: 4px solid #f3f4f6;
        }
        .flow-arrow {
            font-size: 2.5rem;
            line-height: 1;
            color: #118AB2;
            transform: translateY(20px);
        }
        @media (max-width: 767px) {
            .flow-arrow {
                transform: rotate(90deg) translateY(0px);
                margin: 0.5rem 0;
            }
        }
        .modal-overlay {
            transition: opacity 0.3s ease;
        }
        .modal-content {
            transition: transform 0.3s ease;
        }
        .spinner {
            width: 56px;
            height: 56px;
            border: 8px solid #f3f4f6;
            border-top-color: #118AB2;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 text-[#073B4C]">

    <header class="bg-white/80 backdrop-blur-md shadow-md sticky top-0 z-50">
        <nav class="container mx-auto px-4 py-3 flex flex-wrap justify-between items-center">
            <h1 class="text-2xl font-bold text-[#073B4C]">
                Global Lineage Analysis
            </h1>
            <div class="space-x-2 md:space-x-4 text-xs md:text-sm font-semibold">
                <a href="#paternal" class="text-[#118AB2] hover:text-[#06D6A0] transition-colors">Paternal</a>
                <a href="#maternal" class="text-[#118AB2] hover:text-[#06D6A0] transition-colors">Maternal</a>
                <a href="#ethnohistory" class="text-[#118AB2] hover:text-[#06D6A0] transition-colors">Ethnohistory</a>
                <a href="#timeline" class="text-[#118AB2] hover:text-[#06D6A0] transition-colors">Timeline</a>
                <a href="#synthesis" class="text-[#118AB2] hover:text-[#06D6A0] transition-colors">Synthesis</a>
            </div>
        </nav>
    </header>

    <main class="container mx-auto p-4 md:p-8">

        <section id="paternal" class="mb-16 scroll-mt-20">
            <h2 class="text-4xl font-black text-[#118AB2] mb-4 text-center">I. Paternal Lineage (Y-DNA)</h2>
            <p class="text-lg text-gray-700 max-w-3xl mx-auto text-center mb-8">
                Your paternal line traces an ancient journey, originating in Africa and culminating in a distinct, recent branch within the indigenous Amazigh population of Morocco. Your haplogroup is a classic example of the deep-rooted "Berber marker."
            </p>
            <div class="text-center mb-8">
                <button onclick="handleGeminiCall('Paternal Lineage', 'Tell me more about Y-DNA haplogroup E-M81 and what having 17 private variants on E-PF2546 implies for a recent family genealogy.')" class="bg-gradient-to-r from-[#118AB2] to-[#06D6A0] text-white font-bold py-3 px-6 rounded-full shadow-lg hover:shadow-xl transition-transform transform hover:scale-105">
                    ✨ Ask Gemini: What do my private variants mean?
                </button>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-10 items-center">
                <div class="md:col-span-1 bg-white rounded-2xl shadow-lg p-6 text-center">
                    <h3 class="text-2xl font-bold text-[#073B4C] mb-2">Haplogroup E-M81</h3>
                    <p class="text-lg text-gray-600 mb-4">The "Berber Marker"</p>
                    <div class="text-8xl font-black text-[#118AB2]">70%+</div>
                    <p class="text-md text-gray-700 mt-4">
                        Frequency of E-M81 in many Amazigh populations of the Maghreb, making it the dominant paternal lineage in North Africa.
                    </p>
                </div>
                
                <div class="md:col-span-2 bg-white rounded-2xl shadow-lg p-8">
                    <h3 class="text-2xl font-bold text-[#073B4C] mb-6 text-center">Migration Path of Y-DNA E-PF2546</h3>
                    <div class="flex flex-col md:flex-row justify-around items-center text-center">
                        <div class="flex flex-col items-center p-2">
                            <span class="text-xs font-semibold text-gray-500">~70,000 BCE</span>
                            <div class="bg-gray-100 p-4 rounded-xl shadow-inner">
                                <h4 class="text-lg font-bold text-[#073B4C]">Haplogroup E</h4>
                                <p class="text-sm">East Africa</p>
                            </div>
                        </div>
                        <div class="flow-arrow">&rarr;</div>
                        <div class="flex flex-col items-center p-2">
                            <span class="text-xs font-semibold text-gray-500">~14,000 BCE</span>
                            <div class="bg-gray-100 p-4 rounded-xl shadow-inner">
                                <h4 class="text-lg font-bold text-[#073B4C]">E-M81</h4>
                                <p class="text-sm">North Africa (Maghreb)</p>
                            </div>
                        </div>
                        <div class="flow-arrow">&rarr;</div>
                        <div class="flex flex-col items-center p-2">
                            <span class="text-xs font-semibold text-gray-500">~500 BCE</span>
                            <div class="bg-gray-100 p-4 rounded-xl shadow-inner">
                                <h4 class="text-lg font-bold text-[#073B4C]">E-PF2546</h4>
                                <p class="text-sm">Branch forms</p>
                            </div>
                        </div>
                        <div class="flow-arrow">&rarr;</div>
                        <div class="flex flex-col items-center p-2">
                            <span class="text-xs font-semibold text-gray-500">Recent</span>
                            <div class="bg-[#FFD166] p-4 rounded-xl shadow-lg">
                                <h4 class="text-lg font-bold text-[#073B4C]">Your Lineage</h4>
                                <p class="text-sm">(17 Private Variants)</p>
                            </div>
                        </div>
                    </div>
                    <p class="text-gray-700 mt-6">
                        While your root haplogroup E-M81 is ancient and defines the indigenous North African population, your specific subclade E-PF2546 is much younger, with an estimated origin around 500 BCE. The 17 private variants indicate your lineage is a unique and recent branch, likely originating and remaining within the Souss-Massa region.
                    </p>
                </div>
            </div>
        </section>

        <section id="maternal" class="mb-16 scroll-mt-20">
            <h2 class="text-4xl font-black text-[#118AB2] mb-4 text-center">II. Maternal Lineage (mtDNA)</h2>
            <p class="text-lg text-gray-700 max-w-3xl mx-auto text-center mb-8">
                Your maternal line (H1) tells a different story: a journey out of Ice Age Europe. This lineage expanded from the Franco-Cantabrian refuge (Iberia/S. France) and migrated into North Africa thousands of years ago, integrating into the local population.
            </p>
            <div class="text-center mb-8">
                <button onclick="handleGeminiCall('Maternal Lineage', 'Explain the Franco-Cantabrian refuge during the Last Glacial Maximum and how it led to the expansion of mtDNA Haplogroup H1 into both Europe and North Africa.')" class="bg-gradient-to-r from-[#118AB2] to-[#06D6A0] text-white font-bold py-3 px-6 rounded-full shadow-lg hover:shadow-xl transition-transform transform hover:scale-105">
                    ✨ Ask Gemini: More about the Franco-Cantabrian refuge
                </button>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-10">
                <div class="bg-white rounded-2xl shadow-lg p-8">
                    <h3 class="text-2xl font-bold text-[#073B4C] mb-4 text-center">Haplogroup H1 in North Africa</h3>
                    <p class="text-gray-700 mb-4 text-center">
                        Haplogroup H1 is one of the most common maternal lineages in Europe, but it also has a significant, ancient presence in North Africa.
                    </p>
                    <div class="chart-container">
                        <canvas id="h1DistributionChart"></canvas>
                    </div>
                    <p class="text-gray-700 mt-4 text-center">
                        This chart illustrates the high frequency of H1 in Iberia, the likely source population for the H1 lineages found at significant levels (up to 30%) in parts of the Maghreb.
                    </p>
                </div>

                <div class="bg-white rounded-2xl shadow-lg p-8">
                    <h3 class="text-2xl font-bold text-[#073B4C] mb-6 text-center">Migration Path of mtDNA H1</h3>
                    <div class="flex flex-col justify-around items-center text-center space-y-4">
                        <div class="flex flex-col items-center p-2 w-full">
                            <span class="text-xs font-semibold text-gray-500">~20,000 BCE (Last Glacial Maximum)</span>
                            <div class="bg-gray-100 p-4 rounded-xl shadow-inner w-full">
                                <h4 class="text-lg font-bold text-[#073B4C]">Haplogroup H1</h4>
                                <p class="text-sm">Forms in Franco-Cantabrian Refuge (Iberia)</p>
                            </div>
                        </div>
                        <div class="flow-arrow -my-2 md:my-0" style="transform: rotate(90deg);">&darr;</div>
                        <div class="flex flex-col items-center p-2 w-full">
                            <span class="text-xs font-semibold text-gray-500">~14,000 BCE</span>
                            <div class="bg-gray-100 p-4 rounded-xl shadow-inner w-full">
                                <h4 class="text-lg font-bold text-[#073B4C]">European Expansion</h4>
                                <p class="text-sm">H1 repopulates Europe from Iberia</p>
                            </div>
                        </div>
                        <div class="flow-arrow -my-2 md:my-0" style="transform: rotate(90deg);">&darr;</div>
                        <div class="flex flex-col items-center p-2 w-full">
                            <span class="text-xs font-semibold text-gray-500">~7,000 BCE (Neolithic)</span>
                            <div class="bg-gray-100 p-4 rounded-xl shadow-inner w-full">
                                <h4 class="text-lg font-bold text-[#073B4C]">Migration to Maghreb</h4>
                                <p class="text-sm">H1 carriers cross the Strait of Gibraltar</p>
                            </div>
                        </div>
                        <div class="flow-arrow -my-2 md:my-0" style="transform: rotate(90deg);">&darr;</div>
                        <div class="flex flex-col items-center p-2 w-full">
                            <span class="text-xs font-semibold text-gray-500">~8,000-9,000 Years Ago</span>
                            <div class="bg-[#FFD166] p-4 rounded-xl shadow-lg w-full">
                                <h4 class="text-lg font-bold text-[#073B4C]">North African H1</h4>
                                <p class="text-sm">Your maternal lineage becomes rooted in the Maghreb.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="ethnohistory" class="mb-16 scroll-mt-20">
            <h2 class="text-4xl font-black text-[#118AB2] mb-4 text-center">III. Ethnohistory of the Chtouka</h2>
            <p class="text-lg text-gray-700 max-w-3xl mx-auto text-center mb-8">
                Your specific origins in Ait Moussa place you within the Chtouka (Aït Chtouk), a major tribal confederation of the Tachelhit-speaking Amazigh people. This is the heartland of the Shilha culture in the Souss-Massa region.
            </p>
            <div class="text-center mb-8">
                <button onclick="handleGeminiCall('Ethnohistory', 'Using historical and anthropological sources, find specific cultural details about the Ait Moussa tribe, part of the Chtouka confederation in the Souss-Massa region of Morocco.')" class="bg-gradient-to-r from-[#118AB2] to-[#06D6A0] text-white font-bold py-3 px-6 rounded-full shadow-lg hover:shadow-xl transition-transform transform hover:scale-105">
                    ✨ Ask Gemini: Find cultural details on the Ait Moussa
                </button>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-10">
                <div class="bg-white rounded-2xl shadow-lg p-8">
                    <h3 class="text-2xl font-bold text-[#073B4C] mb-6 text-center">Tribal & Cultural Identity</h3>
                    <div class="space-y-4 text-center">
                        <div class="bg-gray-100 p-4 rounded-xl shadow-inner">
                            <h4 class="text-lg font-semibold text-gray-500">Confederation</h4>
                            <p class="text-2xl font-bold text-[#073B4C]">Aït Chtouk (Chtouka)</p>
                        </div>
                        <div class="flex justify-center">
                            <span class="text-2xl text-[#118AB2]">&darr;</span>
                        </div>
                        <div class="bg-gray-100 p-4 rounded-xl shadow-inner">
                            <h4 class="text-lg font-semibold text-gray-500">Tribe / Fraction</h4>
                            <p class="text-2xl font-bold text-[#073B4C]">Ait Moussa</p>
                        </div>
                        <div class="flex justify-center">
                            <span class="text-2xl text-[#118AB2]">&darr;</span>
                        </div>
                        <div class="bg-gray-100 p-4 rounded-xl shadow-inner">
                            <h4 class="text-lg font-semibold text-gray-500">Geographic Center</h4>
                            <p class="text-2xl font-bold text-[#073B4C]">Ait Baha / Souss Valley</p>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white rounded-2xl shadow-lg p-8">
                    <h3 class="text-2xl font-bold text-[#073B4C] mb-6 text-center">Pillars of Souss Culture</h3>
                    <p class="text-gray-700 mb-6">
                        The Chtouka tribes are sedentary agriculturalists and pastoralists, whose society was traditionally built around key cultural and economic pillars.
                    </p>
                    <ul class="space-y-4">
                        <li class="flex items-start p-4 bg-gray-50 rounded-xl">
                            <span class="text-3xl mr-4">&#127963;</span>
                            <div>
                                <h4 class="text-lg font-bold text-[#073B4C]">The Agadir (Igoudar)</h4>
                                <p class="text-gray-700">Iconic collective, fortified granaries used by the tribe to protect food, valuables, and manuscripts.</p>
                            </div>
                        </li>
                        <li class="flex items-start p-4 bg-gray-50 rounded-xl">
                            <span class="text-3xl mr-4">&#129750;</span>
                            <div>
                                <h4 class="text-lg font-bold text-[#073B4C]">Argan Oil Production</h4>
                                <p class="text-gray-700">A foundational economic and culinary resource unique to the Souss region.</p>
                            </div>
                        </li>
                        <li class="flex items-start p-4 bg-gray-50 rounded-xl">
                            <span class="text-3xl mr-4">&#128172;</span>
                            <div>
                                <h4 class="text-lg font-bold text-[#073B4C]">Tachelhit Language</h4>
                                <p class="text-gray-700">The Amazigh language of the Shilha people, preserving ancient oral traditions and poetry.</p>
                            </div>
                        </li>
                    </ul>
                </div>
            </div>
        </section>
        
        <section id="timeline" class="mb-16 scroll-mt-20">
            <h2 class="text-4xl font-black text-[#118AB2] mb-4 text-center">IV. Political & Linguistic Timeline</h2>
            <p class="text-lg text-gray-700 max-w-3xl mx-auto text-center mb-8">
                The Souss region has a complex history, balancing tribal autonomy with the authority of central governments. This timeline highlights the political evolution that your ancestors, the Ait Moussa, experienced.
            </p>
            <div class="text-center mb-8">
                <button onclick="handleGeminiCall('Historical Context', 'What was daily life like for an Amazigh farmer in the Souss region of Morocco during the Almohad Caliphate (12th-13th century)? Describe their social structure, economy, and relationship with the central government.')" class="bg-gradient-to-r from-[#118AB2] to-[#06D6A0] text-white font-bold py-3 px-6 rounded-full shadow-lg hover:shadow-xl transition-transform transform hover:scale-105">
                    ✨ Ask Gemini: Daily life during the Almohad Caliphate
                </button>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-10">
                <div class="md:col-span-2 bg-white rounded-2xl shadow-lg p-10">
                    <h3 class="text-2xl font-bold text-[#073B4C] mb-8 text-center">Political History of the Souss</h3>
                    <div class="relative pl-10 border-l-4 border-gray-200">
                        
                        <div class="mb-10 relative timeline-item">
                            <h4 class="text-xl font-bold text-[#118AB2]">Pre-Islamic Era (c. 1000 BCE - 700 CE)</h4>
                            <p class="text-gray-700">Amazigh tribal structures (like Mauretania) interact with Phoenician, Carthaginian, and Roman settlements. High degree of tribal autonomy.</p>
                        </div>
                        
                        <div class="mb-10 relative timeline-item">
                            <h4 class="text-xl font-bold text-[#118AB2]">Medieval Dynasties (c. 1040 - 1500 CE)</h4>
                            <p class="text-gray-700">The Souss region is integrated into major Moroccan empires, often serving as the cradle of dynasties like the Almoravids and Almohads.</p>
                        </div>

                        <div class="mb-10 relative timeline-item">
                            <h4 class="text-xl font-bold text-[#118AB2]">Siba & Makhzen (c. 1600 - 1912 CE)</h4>
                            <p class="text-gray-700">A long period defined by the split between *Makhzen* (central government) and *Siba* ("dissidence"). The Chtouka tribes often existed in Siba, governing themselves via tribal councils (Jemaas) and local leaders (Amghars).</p>
                        </div>

                        <div class="mb-10 relative timeline-item">
                            <h4 class="text-xl font-bold text-[#118AB2]">French Protectorate (1912 - 1956 CE)</h4>
                            <p class="text-gray-700">French colonial rule is established. The Souss is one of the last regions to be "pacified," and administration is often indirect, relying on co-opted local leaders.</p>
                        </div>

                        <div class="relative timeline-item">
                            <h4 class="text-xl font-bold text-[#118AB2]">Post-Independence (1956 CE - Present)</h4>
                            <p class="text-gray-700">The Souss-Massa region is integrated into the modern Kingdom of Morocco, with Amazigh culture and language (Tachelhit) gaining official recognition.</p>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-2xl shadow-lg p-8 flex flex-col justify-center text-center">
                    <h3 class="text-2xl font-bold text-[#073B4C] mb-4">Linguistic Bedrock</h3>
                    <span class="text-7xl mb-4">&#128172;</span>
                    <h4 class="text-3xl font-bold text-[#06D6A0]">Tachelhit</h4>
                    <p class="text-gray-700 mt-4">
                        This is the Amazigh (Berber) language of your ancestors. Its persistence in the Souss, despite centuries of interaction with Moroccan Arabic (Darija), demonstrates the deep cultural resilience of the Shilha people.
                    </p>
                </div>
            </div>
        </section>

        <section id="synthesis" class="mb-16 scroll-mt-20">
            <h2 class="text-4xl font-black text-[#118AB2] mb-4 text-center">V. Genetic Synthesis: The "H1 Enigma"</h2>
            <p class="text-lg text-gray-700 max-w-3xl mx-auto text-center mb-8">
                Your DNA profile presents a classic and well-studied pattern: a dominant, indigenous North African paternal line (E-M81) combined with a major Eurasian maternal line (H1). This is scientifically explained by ancient, **asymmetrical (or sex-biased) admixture**.
            </p>
            <div class="text-center mb-8">
                <button onclick="handleGeminiCall('Genetic Synthesis', 'Explain the concept of female-mediated gene flow and asymmetrical admixture in population genetics, using the H1 mtDNA and E-M81 Y-DNA pattern in North Africa as a case study.')" class="bg-gradient-to-r from-[#118AB2] to-[#06D6A0] text-white font-bold py-3 px-6 rounded-full shadow-lg hover:shadow-xl transition-transform transform hover:scale-105">
                    ✨ Ask Gemini: Explain asymmetrical admixture
                </button>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-10">
                <div class="bg-white rounded-2xl shadow-lg p-8">
                    <h3 class="text-2xl font-bold text-[#073B4C] mb-4 text-center">Asymmetrical Admixture in North Africa</h3>
                    <p class="text-gray-700 mb-4 text-center">
                        This chart visualizes the stark difference in the origins of the typical Maghrebi gene pool, comparing paternal (Y-DNA) and maternal (mtDNA) lines.
                    </p>
                    <div class="chart-container">
                        <canvas id="admixtureChart"></canvas>
                    </div>
                    <p class="text-gray-700 mt-4 text-center">
                        Your Y-DNA is firmly in the blue bar (Indigenous), while your mtDNA is in the green bar (Eurasian). This demonstrates clear female-mediated gene flow *into* the indigenous population.
                    </p>
                </div>

                <div class="bg-white rounded-2xl shadow-lg p-8">
                    <h3 class="text-2xl font-bold text-[#073B4C] mb-6 text-center">Evaluating the Hypotheses</h3>
                    <p class="text-gray-700 mb-6">
                        The user-posited hypothesis of "extermination" is a non-scientific interpretation. The data points to a far more ancient and complex process of migration and integration.
                    </p>
                    <div class="space-y-4">
                        <div class="border-l-4 border-[#06D6A0] p-5 bg-gray-50 rounded-r-xl">
                            <h4 class="text-lg font-bold text-[#073B4C]">1. Neolithic Migration (Most Likely)</h4>
                            <p class="text-gray-700">Around 7,000 BCE, Neolithic farmers from Iberia (carrying H1 mtDNA) migrated to the Maghreb. These women integrated with the local, established Amazigh males (carrying E-M81 Y-DNA). This is the consensus explanation for the root of H1 in North Africa.</p>
                        </div>
                        <div class="border-l-4 border-[#EF476F] p-5 bg-gray-50 rounded-r-xl">
                            <h4 class="text-lg font-bold text-[#073B4C]">2. Vandal/Alan Invasion (Minimal Impact)</h4>
                            <p class="text-gray-700">The 5th-century CE Vandal migration was too small and too brief to account for the high frequency and deep genetic diversity of H1 in North Africa. Genetic studies show their paternal and maternal impact was negligible.</p>
                        </div>
                        <div class="border-l-4 border-[#FFD166] p-5 bg-gray-50 rounded-r-xl">
                            <h4 class="text-lg font-bold text-[#073B4C]">3. Later Movements (Additive)</h4>
                            <p class="text-gray-700">Movements during the Roman Empire and refugee flows from the Reconquista added to the H1 gene pool, but they did not establish it. Your maternal line is most likely descended from the original Neolithic migrants.</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

    </main>

    <footer class="text-center p-8 bg-white shadow-inner mt-12">
        <p class="text-gray-600">This infographic was generated based on genetic and historical data analysis.</p>
    </footer>

    <div id="geminiModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden">
        <div id="geminiModalOverlay" class="absolute inset-0 bg-black/60 modal-overlay opacity-0"></div>
        <div id="geminiModalContent" class="bg-white rounded-3xl shadow-2xl w-full max-w-2xl max-h-[80vh] flex flex-col transform scale-95 opacity-0 modal-content">
            <div class="flex justify-between items-center p-5 border-b border-gray-200">
                <h3 id="geminiModalTitle" class="text-2xl font-bold text-[#073B4C]"></h3>
                <button id="geminiModalClose" class="text-gray-400 hover:text-gray-600 text-3xl">&times;</button>
            </div>
            <div id="geminiModalBody" class="p-6 overflow-y-auto">
                <div class="flex justify-center items-center h-48">
                    <div class="spinner"></div>
                </div>
            </div>
            <div class="p-4 bg-gray-50 border-t border-gray-200 rounded-b-3xl flex justify-end">
                 <button id="geminiModalTTS" class="bg-[#FFD166] text-[#073B4C] font-semibold py-2 px-4 rounded-xl shadow hover:bg-opacity-90 flex items-center space-x-2 transition-opacity opacity-0 cursor-not-allowed" disabled>
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M7.001 3.001a1 1 0 00-1 1v12a1 1 0 001 1h1a1 1 0 001-1v-4h1.581a1.5 1.5 0 001.309-2.28l-4.5-8a1.5 1.5 0 00-2.618 0l-4.5 8A1.5 1.5 0 004.418 13H6v4a1 1 0 001 1h1a1 1 0 001-1v-4H7V4a1 1 0 00-1-1H7.001zM13 14a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM13 3a1 1 0 011 1v5a1 1 0 11-2 0V4a1 1 0 011-1z"></path></svg>
                    <span id="ttsButtonText">Read Aloud</span>
                </button>
            </div>
        </div>
    </div>

    <script>
        let generatedText = "";
        let audioContext = null;
        let audioSource = null;

        document.addEventListener('DOMContentLoaded', () => {
            
            const tooltipTitleCallback = (tooltipItems) => {
                const item = tooltipItems[0];
                let label = item.chart.data.labels[item.dataIndex];
                if (Array.isArray(label)) {
                    return label.join(' ');
                } else {
                    return label;
                }
            };

            const chartFont = {
                family: 'Lexend',
                size: 14
            };

            const h1Ctx = document.getElementById('h1DistributionChart');
            if (h1Ctx) {
                new Chart(h1Ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Iberia (Source)', 'North Africa (Your Region)', 'Rest of Eurasia'],
                        datasets: [{
                            label: 'H1 Frequency',
                            data: [45, 30, 25],
                            backgroundColor: [
                                '#118AB2',
                                '#06D6A0',
                                '#FFD166'
                            ],
                            borderColor: '#ffffff',
                            borderWidth: 3
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    font: chartFont
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    title: tooltipTitleCallback
                                }
                            }
                        }
                    }
                });
            }

            const admixtureCtx = document.getElementById('admixtureChart');
            if (admixtureCtx) {
                new Chart(admixtureCtx, {
                    type: 'bar',
                    data: {
                        labels: [
                            'Indigenous North African', 
                            ['Eurasian (European', '& Middle Eastern)']
                        ],
                        datasets: [
                            {
                                label: 'Paternal (Y-DNA)',
                                data: [75, 25],
                                backgroundColor: '#118AB2',
                                barPercentage: 0.7,
                                categoryPercentage: 0.6
                            },
                            {
                                label: 'Maternal (mtDNA)',
                                data: [55, 45],
                                backgroundColor: '#06D6A0',
                                barPercentage: 0.7,
                                categoryPercentage: 0.6
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        indexAxis: 'y',
                        scales: {
                            x: {
                                stacked: true,
                                title: {
                                    display: true,
                                    text: 'Percentage of Lineages (%)',
                                    font: chartFont
                                },
                                ticks: {
                                    font: chartFont
                                }
                            },
                            y: {
                                stacked: true,
                                ticks: {
                                    font: chartFont
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    font: chartFont
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    title: tooltipTitleCallback
                                }
                            }
                        }
                    }
                });
            }

            const modal = document.getElementById('geminiModal');
            const overlay = document.getElementById('geminiModalOverlay');
            const content = document.getElementById('geminiModalContent');
            const closeButton = document.getElementById('geminiModalClose');
            const ttsButton = document.getElementById('geminiModalTTS');
            const ttsButtonText = document.getElementById('ttsButtonText');

            const openModal = () => {
                modal.classList.remove('hidden');
                setTimeout(() => {
                    overlay.classList.remove('opacity-0');
                    content.classList.remove('opacity-0', 'scale-95');
                }, 10);
            };

            const closeModal = () => {
                stopAudio();
                overlay.classList.add('opacity-0');
                content.classList.add('opacity-0', 'scale-95');
                setTimeout(() => {
                    modal.classList.add('hidden');
                    document.getElementById('geminiModalBody').innerHTML = '<div class="flex justify-center items-center h-48"><div class="spinner"></div></div>';
                    ttsButton.classList.add('opacity-0', 'cursor-not-allowed');
                    ttsButton.disabled = true;
                    ttsButtonText.textContent = 'Read Aloud';
                    generatedText = "";
                }, 300);
            };

            closeButton.onclick = closeModal;
            overlay.onclick = closeModal;
            ttsButton.onclick = () => {
                if (audioSource) {
                    stopAudio();
                } else if (generatedText) {
                    handleGeminiTTS(generatedText);
                }
            };
        });

        const exponentialBackoff = async (fn, maxRetries = 5, baseDelay = 1000) => {
            let attempt = 0;
            while (attempt < maxRetries) {
                try {
                    return await fn();
                } catch (error) {
                    if (attempt === maxRetries - 1) throw error;
                    const delay = baseDelay * Math.pow(2, attempt) + Math.random() * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                    attempt++;
                }
            }
        };

        const handleGeminiCall = async (title, userPrompt) => {
            const modalTitle = document.getElementById('geminiModalTitle');
            const modalBody = document.getElementById('geminiModalBody');
            const ttsButton = document.getElementById('geminiModalTTS');
            
            modalTitle.textContent = title;
            document.getElementById('geminiModal').classList.remove('hidden');
            setTimeout(() => {
                document.getElementById('geminiModalOverlay').classList.remove('opacity-0');
                document.getElementById('geminiModalContent').classList.remove('opacity-0', 'scale-95');
            }, 10);

            const systemPrompt = "Act as a world-class historical and population genetics researcher. Your tone is scholarly, clear, and informative. Provide a detailed, multi-paragraph response based on the user's query. Use Google Search to find specific, relevant facts, dates, and genetic studies to support your analysis. Format your answer with markdown for readability (e.g., headings, bullet points).";
            
            try {
                const result = await callGeminiAPI(userPrompt, systemPrompt);
                generatedText = result.text.replace(/(\*\*|__)(.*?)\1/g, '$2').replace(/(\*|_)(.*?)\1/g, '$2').replace(/#/g, '');
                
                let htmlContent = generatedText.split('\n').map(p => {
                    if (p.trim() === '') return '';
                    if (p.trim().startsWith('- ')) return `<ul class="list-disc list-inside mb-4"><li>${p.trim().substring(2)}</li></ul>`;
                    return `<p class="text-gray-700 mb-4">${p}</p>`;
                }).join('');

                modalBody.innerHTML = `<div class="prose prose-lg max-w-none">${htmlContent}</div>`;
                ttsButton.classList.remove('opacity-0', 'cursor-not-allowed');
                ttsButton.disabled = false;
            } catch (error) {
                modalBody.innerHTML = `<p class="text-red-600">Sorry, an error occurred while fetching the information. Please try again later.</p>`;
            }
        };

        const callGeminiAPI = async (userQuery, systemPrompt) => {
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
            };

            const fetchWithBackoff = () => fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const response = await exponentialBackoff(fetchWithBackoff);

            if (!response.ok) {
                throw new Error(`API request failed with status ${response.status}`);
            }

            const result = await response.json();
            const candidate = result.candidates?.[0];

            if (candidate && candidate.content?.parts?.[0]?.text) {
                const text = candidate.content.parts[0].text;
                let sources = [];
                const groundingMetadata = candidate.groundingMetadata;
                if (groundingMetadata && groundingMetadata.groundingAttributions) {
                    sources = groundingMetadata.groundingAttributions
                        .map(attribution => ({
                            uri: attribution.web?.uri,
                            title: attribution.web?.title,
                        }))
                        .filter(source => source.uri && source.title);
                }
                return { text, sources };
            } else {
                throw new Error("Invalid response structure from API.");
            }
        };

        const handleGeminiTTS = async (textToSpeak) => {
            const ttsButton = document.getElementById('geminiModalTTS');
            const ttsButtonText = document.getElementById('ttsButtonText');
            ttsButton.disabled = true;
            ttsButtonText.textContent = 'Loading Audio...';

            try {
                const audioData = await callGeminiTTSAPI(textToSpeak);
                const sampleRate = 24000;
                const pcmData = base64ToArrayBuffer(audioData);
                const pcm16 = new Int16Array(pcmData);
                const wavBlob = pcmToWav(pcm16, sampleRate);
                const audioUrl = URL.createObjectURL(wavBlob);
                
                playAudio(audioUrl, () => {
                    ttsButtonText.textContent = 'Read Aloud';
                    ttsButton.disabled = false;
                });
                ttsButtonText.textContent = 'Stop Audio';
                ttsButton.disabled = false;

            } catch (error) {
                ttsButtonText.textContent = 'TTS Error';
                ttsButton.disabled = false;
            }
        };

        const callGeminiTTSAPI = async (textToSpeak) => {
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{
                    parts: [{ text: `Say in an informative, scholarly tone: ${textToSpeak}` }]
                }],
                generationConfig: {
                    responseModalities: ["AUDIO"],
                    speechConfig: {
                        voiceConfig: {
                            prebuiltVoiceConfig: { voiceName: "Charon" }
                        }
                    }
                },
                model: "gemini-2.5-flash-preview-tts"
            };

            const fetchWithBackoff = () => fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const response = await exponentialBackoff(fetchWithBackoff);

            if (!response.ok) {
                throw new Error(`TTS API request failed with status ${response.status}`);
            }

            const result = await response.json();
            const part = result?.candidates?.[0]?.content?.parts?.[0];
            const audioData = part?.inlineData?.data;

            if (audioData) {
                return audioData;
            } else {
                throw new Error("Invalid TTS response structure from API.");
            }
        };

        const playAudio = (url, onEndedCallback) => {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
            
            fetch(url)
                .then(response => response.arrayBuffer())
                .then(arrayBuffer => audioContext.decodeAudioData(arrayBuffer))
                } catch (error) {
                ttsButtonText.textContent = 'TTS Error';
                ttsButton.disabled = false;
            }
        };

        const callGeminiTTSAPI = async (textToSpeak) => {
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{
                    parts: [{ text: `Say in an informative, scholarly tone: ${textToSpeak}` }]
                }],
                generationConfig: {
                    responseModalities: ["AUDIO"],
                    speechConfig: {
                        voiceConfig: {
                            prebuiltVoiceConfig: { voiceName: "Charon" }
                        }
                    }
                },
                model: "gemini-2.5-flash-preview-tts"
            };

            const fetchWithBackoff = () => fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const response = await exponentialBackoff(fetchWithBackoff);

            if (!response.ok) {
                throw new Error(`TTS API request failed with status ${response.status}`);
            }

            const result = await response.json();
            const part = result?.candidates?.[0]?.content?.parts?.[0];
            const audioData = part?.inlineData?.data;

            if (audioData) {
                return audioData;
            } else {
                throw new Error("Invalid TTS response structure from API.");
            }
        };

        const playAudio = (url, onEndedCallback) => {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
            
            fetch(url)
                .then(response => response.arrayBuffer())
                .then(arrayBuffer => audioContext.decodeAudioData(arrayBuffer))
                .then(audioBuffer => {
                    stopAudio();
                    audioSource = audioContext.createBufferSource();
                    audioSource.buffer = audioBuffer;
                    audioSource.connect(audioContext.destination);
                    audioSource.start(0);
                    audioSource.onended = () => {
                        audioSource = null;
                        onEndedCallback();
                    };
                });
        };

        const stopAudio = () => {
            if (audioSource) {
                audioSource.stop(0);
                audioSource.disconnect();
                audioSource = null;
            }
            document.getElementById('ttsButtonText').textContent = 'Read Aloud';
            document.getElementById('geminiModalTTS').disabled = false;
        };
        
        const base64ToArrayBuffer = (base64) => {
            const binaryString = window.atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        };

        const pcmToWav = (pcmData, sampleRate) => {
            const numChannels = 1;
            const bitsPerSample = 16;
            const blockAlign = (numChannels * bitsPerSample) / 8;
            const byteRate = sampleRate * blockAlign;
            const dataSize = pcmData.length * (bitsPerSample / 8);
            const buffer = new ArrayBuffer(44 + dataSize);
            const view = new DataView(buffer);

            function writeString(view, offset, string) {
                for (let i = 0; i < string.length; i++) {
                    view.setUint8(offset + i, string.charCodeAt(i));
                }
            }

            writeString(view, 0, 'RIFF');
            view.setUint32(4, 36 + dataSize, true);
            writeString(view, 8, 'WAVE');
            writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true);
            view.setUint16(22, numChannels, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, byteRate, true);
            view.setUint16(32, blockAlign, true);
            view.setUint16(34, bitsPerSample, true);
            writeString(view, 36, 'data');
            view.setUint32(40, dataSize, true);

            for (let i = 0; i < pcmData.length; i++) {
                view.setInt16(44 + i * 2, pcmData[i], true);
            }

            return new Blob([view], { type: 'audio/wav' });
        };
    </script>

</body>
</html>


